<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–∏—Ç–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Google Translate -->
    <script src="https://cdn.jsdelivr.net/npm/@google-cloud/translate/build/protos/google/cloud/translate/v3/translate_pb.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .search-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .search-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .search-header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .search-btn {
            padding: 14px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-btn:hover {
            background: #2980b9;
        }
        
        .translation-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            color: #2e7d32;
        }
        
        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .food-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            text-align: center;
        }
        
        .food-card:hover {
            transform: translateY(-5px);
        }
        
        .food-name {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 10px;
        }
        
        .food-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            margin: 10px auto;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #6c757d;
        }
        
        .add-btn {
            width: 100%;
            padding: 12px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .add-btn:hover {
            background: #27ae60;
        }
        
        .add-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .serving-info {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 10px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .no-results-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #c62828;
            margin: 20px 0;
        }
        
        .retry-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .api-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            color: #1976d2;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .meal-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .meal-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .meal-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .meal-option.active {
            border-color: #3498db;
            background-color: #3498db;
            color: white;
        }

        .meal-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .modal-btn.confirm {
            background-color: #2ecc71;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #27ae60;
        }

        .modal-btn.cancel {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #7f8c8d;
        }

        @media (max-width: 600px) {
            .search-box {
                flex-direction: column;
            }
            
            .food-grid {
                grid-template-columns: 1fr;
            }
            
            .meal-options {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
        .grams-input-container {
            margin: 20px 0;
        }
        
        .grams-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        
        .grams-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .grams-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–ª–æ—Ä–∏–π –∏ –ë–ñ–£ */
        .nutrition-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .nutrition-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .nutrition-item {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nutrition-value {
            font-weight: bold;
            font-size: 16px;
            color: #3498db;
        }
        
        .nutrition-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .calories-item {
            grid-column: span 4;
            background-color: #e3f2fd;
        }
        
        .calories-value {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-header">
            <h1><i class="fas fa-apple-alt"></i> –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–∏—Ç–∞–Ω–∏—è</h1>
            <p>–ù–∞–π–¥–∏—Ç–µ –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –ª—é–±—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ FatSecret API</p>
        </div>
        
        <div class="footer-nav">
            <a href="{{ url_for('index') }}" class="nav-item active">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>

        
        <div class="search-box">
            <input type="text" class="search-input" id="food-query" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —è–±–ª–æ–∫–æ, –∫—É—Ä–∏—Ü–∞, –æ–≤—Å—è–Ω–∫–∞)...">
            <button class="search-btn" onclick="searchFood()">
                <i class="fas fa-search"></i> –ü–æ–∏—Å–∫
            </button>
        </div>
        
        <div id="translation-info" class="translation-info" style="display: none;">
            <i class="fas fa-language"></i> 
            <span id="translation-text"></span>
        </div>
        
        <div id="results-container">
            <div class="no-results">
                <div class="no-results-icon">üçΩÔ∏è</div>
                <p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞</p>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: —è–±–ª–æ–∫–æ, –∫—É—Ä–∏—Ü–∞, –±–∞–Ω–∞–Ω, –æ–≤—Å—è–Ω–∫–∞, —Ç–≤–æ—Ä–æ–≥</p>
            </div>
        </div>

                <div class="footer-nav">
            <a href="{{ url_for('index') }}" style="text-decoration: none;" class="nav-item active">
                <i>ü•ó</i>
                <span>–†–∞—Ü–∏–æ–Ω</span>
            </a>
            <a href="{{ url_for('dci') }}" style="text-decoration: none;" class="nav-item">
                <i>‚ö°</i>
                <span>–°–ù–ö</span>
            </a>
            <a href="{{ url_for('stats') }}" style="text-decoration: none;" class="nav-item">
                <i>üìà</i>
                <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
            </a>
            <a href="{{ url_for('bmi') }}" style="text-decoration: none;" class="nav-item">
                <i>üìä</i>
                <span>–ò–ú–¢</span>
            </a>
            <a href="{{ url_for('profile') }}" style="text-decoration: none;" class="nav-item">
                <i>üë§</i>
                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
            </a>
            <a href="{{ url_for('fatsecret_search') }}" style="color: rgb(10, 169, 222); text-decoration: none;" class="nav-item">
                <i>üîç</i>
                <span>–ü–æ–∏—Å–∫</span>
            </a>
        </div>
    </div>

    <div id="meal-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
            
            <div class="food-info" id="modal-food-info" style="text-align: center; margin-bottom: 15px;">
                <strong id="modal-food-name"></strong>
            </div>
            
            <div class="grams-input-container">
                <label class="grams-label" for="grams-input">–í–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞ (–≥):</label>
                <input type="number" class="grams-input" id="grams-input" value="100" min="1" max="1000" oninput="updateNutritionInfo()">
            </div>
            
            <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–ª–æ—Ä–∏–π –∏ –ë–ñ–£ -->
            <div class="nutrition-info" id="nutrition-info" style="display: none;">
                <div class="nutrition-title">–ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ <span id="nutrition-grams">100</span> –≥:</div>
                <div class="nutrition-grid">
                    <div class="nutrition-item calories-item">
                        <div class="nutrition-value calories-value" id="nutrition-calories">0</div>
                        <div class="nutrition-label">–ö–∞–ª–æ—Ä–∏–∏</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="nutrition-protein">0</div>
                        <div class="nutrition-label">–ë–µ–ª–∫–∏ (–≥)</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="nutrition-fat">0</div>
                        <div class="nutrition-label">–ñ–∏—Ä—ã (–≥)</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="nutrition-carbs">0</div>
                        <div class="nutrition-label">–£–≥–ª–µ–≤–æ–¥—ã (–≥)</div>
                    </div>
                </div>
            </div>
            
            <h3 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–µ–º –ø–∏—â–∏</h3>
            <div class="meal-options">
                <div class="meal-option" data-meal="breakfast">
                    <div class="meal-icon">üç≥</div>
                    <div>–ó–∞–≤—Ç—Ä–∞–∫</div>
                </div>
                <div class="meal-option" data-meal="lunch">
                    <div class="meal-icon">üç≤</div>
                    <div>–û–±–µ–¥</div>
                </div>
                <div class="meal-option" data-meal="dinner">
                    <div class="meal-icon">üçΩÔ∏è</div>
                    <div>–£–∂–∏–Ω</div>
                </div>
                <div class="meal-option" data-meal="snack">
                    <div class="meal-icon">üçé</div>
                    <div>–ü–µ—Ä–µ–∫—É—Å</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn confirm" onclick="confirmMealSelection()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>


    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
        let currentFoodId = null;
        let currentFoodName = null;
        let currentFoodDetails = null;
        let selectedMeal = 'lunch';
        let baseNutrition = null; // –ë–∞–∑–æ–≤–∞—è –ø–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 100–≥
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Google Translate API
        async function translateToEnglish(text) {
            if (!text) return text;
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è Google Translate
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ru&tl=en&dt=t&q=${encodeURIComponent(text)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data[0] && data[0][0] && data[0][0][0]) {
                        return data[0][0][0];
                    }
                }
                
                // –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback —Å–ª–æ–≤–∞—Ä—å
                return translateWithDictionary(text);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
                return translateWithDictionary(text);
            }
        }

        // Fallback —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
        function translateWithDictionary(text) {
            const dictionary = {
                '—è–π—Ü–æ': 'egg', '—è–π—Ü–∞': 'eggs', '—è–∏—á–Ω—ã–π': 'egg',
                '—è–±–ª–æ–∫–æ': 'apple', '—è–±–ª–æ–∫–∏': 'apples',
                '–∫—É—Ä–∏—Ü–∞': 'chicken', '–∫—É—Ä–∏–Ω—ã–π': 'chicken',
                '–≥–æ–≤—è–¥–∏–Ω–∞': 'beef',
                '—Å–≤–∏–Ω–∏–Ω–∞': 'pork',
                '—Ä—ã–±–∞': 'fish',
                '–ª–æ—Å–æ—Å—å': 'salmon',
                '—Ç–≤–æ—Ä–æ–≥': 'cottage cheese',
                '–º–æ–ª–æ–∫–æ': 'milk',
                '—Å—ã—Ä': 'cheese',
                '—Ö–ª–µ–±': 'bread',
                '—Ä–∏—Å': 'rice',
                '–≥—Ä–µ—á–∫–∞': 'buckwheat',
                '–æ–≤—Å—è–Ω–∫–∞': 'oatmeal',
                '–º–∞–∫–∞—Ä–æ–Ω—ã': 'pasta',
                '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å': 'potato',
                '–º–æ—Ä–∫–æ–≤—å': 'carrot',
                '–ø–æ–º–∏–¥–æ—Ä': 'tomato',
                '–æ–≥—É—Ä–µ—Ü': 'cucumber',
                '–±–∞–Ω–∞–Ω': 'banana',
                '–∞–ø–µ–ª—å—Å–∏–Ω': 'orange',
                '–≤–∏–Ω–æ–≥—Ä–∞–¥': 'grapes',
                '–∫–ª—É–±–Ω–∏–∫–∞': 'strawberry',
                '–º–∞–ª–∏–Ω–∞': 'raspberry',
                '–æ—Ä–µ—Ö–∏': 'nuts',
                '–º–∏–Ω–¥–∞–ª—å': 'almonds',
                '–≥—Ä–µ—Ü–∫–∏–π': 'walnut',
                '–º–µ–¥': 'honey',
                '—Å–∞—Ö–∞—Ä': 'sugar',
                '—Å–æ–ª—å': 'salt',
                '–ø–µ—Ä–µ—Ü': 'pepper',
                '–º–∞—Å–ª–æ': 'oil',
                '–æ–ª–∏–≤–∫–æ–≤–æ–µ': 'olive oil',
                '–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ': 'sunflower oil',
                '–≤–æ–¥–∞': 'water',
                '–∫–æ—Ñ–µ': 'coffee',
                '—á–∞–π': 'tea'
            };

            const words = text.toLowerCase().split(' ');
            let translatedWords = [];
            
            for (const word of words) {
                if (dictionary[word]) {
                    translatedWords.push(dictionary[word]);
                } else {
                    let found = false;
                    for (const [russian, english] of Object.entries(dictionary)) {
                        if (word.includes(russian)) {
                            translatedWords.push(english);
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        translatedWords.push(word);
                    }
                }
            }
            
            return translatedWords.join(' ');
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function openModal(foodId, foodName) {
            currentFoodId = foodId;
            currentFoodName = foodName;
            selectedMeal = 'lunch';
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('modal-food-name').textContent = foodName;
            
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ —É –≤—Å–µ—Ö –æ–ø—Ü–∏–π
            document.querySelectorAll('.meal-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è –æ–±–µ–¥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            document.querySelector('.meal-option[data-meal="lunch"]').classList.add('active');
            
            // –°–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏—è –≥—Ä–∞–º–º–æ–≤ –∫ 100
            document.getElementById('grams-input').value = 100;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            document.getElementById('nutrition-info').style.display = 'none';
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤
            getFoodDetails(foodId);
            
            document.getElementById('meal-modal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞
        async function getFoodDetails(foodId) {
            try {
                const response = await fetch(`/get-food-details/${foodId}`);
                if (response.ok) {
                    const data = await response.json();
                    currentFoodDetails = data.food;
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –±–∞–∑–æ–≤—É—é –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 100–≥
                    if (currentFoodDetails && currentFoodDetails.servings) {
                        const servings = currentFoodDetails.servings.serving;
                        const serving = Array.isArray(servings) ? servings[0] : servings;
                        
                        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–º–º –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–æ—Ä—Ü–∏–∏
                        const servingGrams = parseFloat(serving.metric_serving_amount || serving.grams || 100);
                        
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ 100–≥
                        baseNutrition = {
                            calories: Math.round(parseFloat(serving.calories) * (100 / servingGrams)),
                            protein: Math.round(parseFloat(serving.protein || 0) * (100 / servingGrams) * 10) / 10,
                            fat: Math.round(parseFloat(serving.fat || 0) * (100 / servingGrams) * 10) / 10,
                            carbs: Math.round(parseFloat(serving.carbohydrate || 0) * (100 / servingGrams) * 10) / 10
                        };
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
                        updateNutritionInfo();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                        document.getElementById('nutrition-info').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
        function updateNutritionInfo() {
            if (!baseNutrition) return;
            
            const grams = parseInt(document.getElementById('grams-input').value) || 100;
            const ratio = grams / 100;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–º–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            document.getElementById('nutrition-grams').textContent = grams;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            document.getElementById('nutrition-calories').textContent = Math.round(baseNutrition.calories * ratio);
            document.getElementById('nutrition-protein').textContent = (baseNutrition.protein * ratio).toFixed(1);
            document.getElementById('nutrition-fat').textContent = (baseNutrition.fat * ratio).toFixed(1);
            document.getElementById('nutrition-carbs').textContent = (baseNutrition.carbs * ratio).toFixed(1);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–∞
        function calculateNutrition(serving, grams) {
            if (!serving || !serving.calories) return null;
            
            const servingGrams = parseFloat(serving.metric_serving_amount || serving.grams || 100);
            const ratio = grams / servingGrams;
            
            return {
                calories: Math.round(parseFloat(serving.calories) * ratio),
                protein: Math.round(parseFloat(serving.protein || 0) * ratio * 10) / 10,
                fat: Math.round(parseFloat(serving.fat || 0) * ratio * 10) / 10,
                carbs: Math.round(parseFloat(serving.carbohydrate || 0) * ratio * 10) / 10,
                grams: grams
            };
        }

        function closeModal() {
            document.getElementById('meal-modal').style.display = 'none';
            currentFoodId = null;
            currentFoodName = null;
            baseNutrition = null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
        function confirmMealSelection() {
            const grams = parseInt(document.getElementById('grams-input').value) || 100;
            
            if (grams <= 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–º–º–æ–≤');
                return;
            }
            
            if (currentFoodId && currentFoodName) {
                addToDiary(currentFoodId, currentFoodName, selectedMeal, grams, currentFoodDetails);
            }
            closeModal();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        function initMealSelection() {
            document.querySelectorAll('.meal-option').forEach(option => {
                option.addEventListener('click', function() {
                    // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –æ–ø—Ü–∏–π
                    document.querySelectorAll('.meal-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
                    this.classList.add('active');
                    selectedMeal = this.getAttribute('data-meal');
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        async function searchFood() {
            const originalQuery = document.getElementById('food-query').value.trim();
            if (!originalQuery) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞');
                return;
            }

            const resultsDiv = document.getElementById('results-container');
            const translationInfo = document.getElementById('translation-info');
            const translationText = document.getElementById('translation-text');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–µ—Ä–µ–≤–æ–¥–∞
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>–ü–µ—Ä–µ–≤–æ–¥–∏–º "${escapeHtml(originalQuery)}" –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π...</p>
                </div>
            `;

            try {
                // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
                const englishQuery = await translateToEnglish(originalQuery);
                
                if (originalQuery !== englishQuery) {
                    translationText.innerHTML = `–ü–æ–∏—Å–∫: "<strong>${escapeHtml(originalQuery)}</strong>" ‚Üí "<strong>${escapeHtml(englishQuery)}</strong>"`;
                    translationInfo.style.display = 'block';
                } else {
                    translationInfo.style.display = 'none';
                }

                resultsDiv.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>–ò—â–µ–º "${escapeHtml(originalQuery)}" –≤ –±–∞–∑–µ FatSecret...</p>
                        ${originalQuery !== englishQuery ? `<p>–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –∫–∞–∫: "${escapeHtml(englishQuery)}"</p>` : ''}
                    </div>
                `;

                const response = await fetch(`/search-food?query=${encodeURIComponent(englishQuery)}&region=RU&language=ru`);
                
                let data;
                if (response.ok) {
                    data = await response.json();
                    console.log('–û—Ç–≤–µ—Ç API:', data);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ API, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ');
                }
                
                if (data.foods && data.foods.food && data.foods.food.length > 0) {
                    displayResults(data.foods.food, originalQuery, englishQuery);
                } else if (data.food) {
                    displayResults([data.food], originalQuery, englishQuery);
                } else {
                    throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <h3><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</h3>
                        <p>${escapeHtml(error.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫'}</p>
                        <button class="retry-btn" onclick="searchFood()">
                            <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–±–µ–∑ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤)
        function displayResults(foods, originalQuery, englishQuery) {
            const container = document.getElementById('results-container');
            
            if (!foods || foods.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è "${escapeHtml(originalQuery)}"</p>
                        ${originalQuery !== englishQuery ? `<p>–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: "${escapeHtml(englishQuery)}"</p>` : ''}
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="api-info">
                    <i class="fas fa-info-circle"></i> 
                    –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${foods.length} | 
                    –ü–æ–∏—Å–∫: "${escapeHtml(originalQuery)}" 
                    ${originalQuery !== englishQuery ? `‚Üí "${escapeHtml(englishQuery)}"` : ''}
                </div>
                <div class="food-grid">
            `;
            
            foods.forEach(food => {
                const foodName = escapeHtml(food.food_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç');
                const foodId = escapeHtml(food.food_id || '');
                const foodType = escapeHtml(food.food_type || '–ø—Ä–æ–¥—É–∫—Ç');
                
                html += `
                <div class="food-card">
                    <div class="food-name">${foodName}</div>
                    
                    <div class="food-image">
                        ${food.food_image ? 
                          `<img src="${escapeHtml(food.food_image)}" alt="${foodName}" style="width:100%;height:100%;border-radius:10px;">` : 
                          'üçé'}
                    </div>
                    
                    <div class="serving-info">
                        ${food.food_type ? `–¢–∏–ø: ${escapeHtml(foodType)}` : '–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç'}
                    </div>
                    
                    <button class="add-btn" onclick="openModal('${foodId}', '${foodName.replace(/'/g, "\\'")}')">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–∞—Ü–∏–æ–Ω
                    </button>
                </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getMealName(mealType) {
            const meals = {
                'breakfast': '–∑–∞–≤—Ç—Ä–∞–∫',
                'lunch': '–æ–±–µ–¥',
                'dinner': '—É–∂–∏–Ω',
                'snack': '–ø–µ—Ä–µ–∫—É—Å'
            };
            return meals[mealType] || '–¥–Ω–µ–≤–Ω–∏–∫';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –¥–Ω–µ–≤–Ω–∏–∫
        async function addToDiary(foodId, foodName, mealType, grams, foodDetails = null) {
            const buttons = document.querySelectorAll('.add-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(foodName)) {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> –î–æ–±–∞–≤–ª—è–µ–º...`;
                }
            });
            
            try {
                // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞, —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞
                let nutritionData = null;
                if (foodDetails && foodDetails.servings) {
                    const servings = foodDetails.servings.serving;
                    const serving = Array.isArray(servings) ? servings[0] : servings;
                    nutritionData = calculateNutrition(serving, grams);
                }
                
                const response = await fetch('/add-from-fatsecret', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        food_id: foodId,
                        meal_type: mealType,
                        grams: grams,
                        nutrition_data: nutritionData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`‚úÖ "${foodName}" (${grams}–≥) –¥–æ–±–∞–≤–ª–µ–Ω –≤ ${getMealName(mealType)}!`);
                    } else {
                        throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏');
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                buttons.forEach(btn => {
                    if (btn.textContent.includes('–î–æ–±–∞–≤–ª—è–µ–º')) {
                        btn.disabled = false;
                        btn.innerHTML = `<i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–∞—Ü–∏–æ–Ω`;
                    }
                });
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
        document.getElementById('food-query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchFood();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('meal-modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initMealSelection();
            document.getElementById('food-query').focus();
        });
    </script>
</body>
</html>