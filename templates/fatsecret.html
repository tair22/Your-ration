<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск продуктов питания</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Добавляем библиотеку Google Translate -->
    <script src="https://cdn.jsdelivr.net/npm/@google-cloud/translate/build/protos/google/cloud/translate/v3/translate_pb.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .search-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .search-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .search-header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .search-btn {
            padding: 14px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-btn:hover {
            background: #2980b9;
        }
        
        .translation-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            color: #2e7d32;
        }
        
        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .food-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            text-align: center;
        }
        
        .food-card:hover {
            transform: translateY(-5px);
        }
        
        .food-name {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 10px;
        }
        
        .food-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            margin: 10px auto;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #6c757d;
        }
        
        .add-btn {
            width: 100%;
            padding: 12px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .add-btn:hover {
            background: #27ae60;
        }
        
        .add-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .serving-info {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 10px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .no-results-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #c62828;
            margin: 20px 0;
        }
        
        .retry-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .api-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            color: #1976d2;
        }

        /* Модальное окно для выбора приема пищи */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .meal-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .meal-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .meal-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .meal-option.active {
            border-color: #3498db;
            background-color: #3498db;
            color: white;
        }

        .meal-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .modal-btn.confirm {
            background-color: #2ecc71;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #27ae60;
        }

        .modal-btn.cancel {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #7f8c8d;
        }

        @media (max-width: 600px) {
            .search-box {
                flex-direction: column;
            }
            
            .food-grid {
                grid-template-columns: 1fr;
            }
            
            .meal-options {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
        .grams-input-container {
            margin: 20px 0;
        }
        
        .grams-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        
        .grams-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .grams-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        /* Стили для отображения калорий и БЖУ */
        .nutrition-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .nutrition-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .nutrition-item {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nutrition-value {
            font-weight: bold;
            font-size: 16px;
            color: #3498db;
        }
        
        .nutrition-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .calories-item {
            grid-column: span 4;
            background-color: #e3f2fd;
        }
        
        .calories-value {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-header">
            <h1><i class="fas fa-apple-alt"></i> Поиск продуктов питания</h1>
            <p>Найдите пищевую ценность любых продуктов через FatSecret API</p>
        </div>
        
        <div class="footer-nav">
            <a href="{{ url_for('index') }}" class="nav-item active">← На главную</a>
        </div>

        
        <div class="search-box">
            <input type="text" class="search-input" id="food-query" 
                   placeholder="Введите название продукта на русском (например, яблоко, курица, овсянка)...">
            <button class="search-btn" onclick="searchFood()">
                <i class="fas fa-search"></i> Поиск
            </button>
        </div>
        
        <div id="translation-info" class="translation-info" style="display: none;">
            <i class="fas fa-language"></i> 
            <span id="translation-text"></span>
        </div>
        
        <div id="results-container">
            <div class="no-results">
                <div class="no-results-icon">🍽️</div>
                <p>Введите название продукта для поиска</p>
                <p>Попробуйте: яблоко, курица, банан, овсянка, творог</p>
            </div>
        </div>

                <div class="footer-nav">
            <a href="{{ url_for('index') }}" style="text-decoration: none;" class="nav-item active">
                <i>🥗</i>
                <span>Рацион</span>
            </a>
            <a href="{{ url_for('dci') }}" style="text-decoration: none;" class="nav-item">
                <i>⚡</i>
                <span>СНК</span>
            </a>
            <a href="{{ url_for('stats') }}" style="text-decoration: none;" class="nav-item">
                <i>📈</i>
                <span>Статистика</span>
            </a>
            <a href="{{ url_for('bmi') }}" style="text-decoration: none;" class="nav-item">
                <i>📊</i>
                <span>ИМТ</span>
            </a>
            <a href="{{ url_for('profile') }}" style="text-decoration: none;" class="nav-item">
                <i>👤</i>
                <span>Профиль</span>
            </a>
            <a href="{{ url_for('fatsecret_search') }}" style="color: rgb(10, 169, 222); text-decoration: none;" class="nav-item">
                <i>🔍</i>
                <span>Поиск</span>
            </a>
        </div>
    </div>

    <div id="meal-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Добавить продукт</h3>
            
            <div class="food-info" id="modal-food-info" style="text-align: center; margin-bottom: 15px;">
                <strong id="modal-food-name"></strong>
            </div>
            
            <div class="grams-input-container">
                <label class="grams-label" for="grams-input">Вес продукта (г):</label>
                <input type="number" class="grams-input" id="grams-input" value="100" min="1" max="1000" oninput="updateNutritionInfo()">
            </div>
            
            <!-- Блок для отображения калорий и БЖУ -->
            <div class="nutrition-info" id="nutrition-info" style="display: none;">
                <div class="nutrition-title">Пищевая ценность на <span id="nutrition-grams">100</span> г:</div>
                <div class="nutrition-grid">
                    <div class="nutrition-item calories-item">
                        <div class="nutrition-value calories-value" id="nutrition-calories">0</div>
                        <div class="nutrition-label">Калории</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="nutrition-protein">0</div>
                        <div class="nutrition-label">Белки (г)</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="nutrition-fat">0</div>
                        <div class="nutrition-label">Жиры (г)</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="nutrition-carbs">0</div>
                        <div class="nutrition-label">Углеводы (г)</div>
                    </div>
                </div>
            </div>
            
            <h3 class="modal-title">Выберите прием пищи</h3>
            <div class="meal-options">
                <div class="meal-option" data-meal="breakfast">
                    <div class="meal-icon">🍳</div>
                    <div>Завтрак</div>
                </div>
                <div class="meal-option" data-meal="lunch">
                    <div class="meal-icon">🍲</div>
                    <div>Обед</div>
                </div>
                <div class="meal-option" data-meal="dinner">
                    <div class="meal-icon">🍽️</div>
                    <div>Ужин</div>
                </div>
                <div class="meal-option" data-meal="snack">
                    <div class="meal-icon">🍎</div>
                    <div>Перекус</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">Отмена</button>
                <button class="modal-btn confirm" onclick="confirmMealSelection()">Добавить</button>
            </div>
        </div>
    </div>


    <script>
        // Переменные для хранения текущего выбранного продукта
        let currentFoodId = null;
        let currentFoodName = null;
        let currentFoodDetails = null;
        let selectedMeal = 'lunch';
        let baseNutrition = null; // Базовая пищевая ценность на 100г
        
        // Функция для перевода русского текста на английский с использованием Google Translate API
        async function translateToEnglish(text) {
            if (!text) return text;
            
            try {
                // Используем бесплатный прокси для Google Translate
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ru&tl=en&dt=t&q=${encodeURIComponent(text)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data[0] && data[0][0] && data[0][0][0]) {
                        return data[0][0][0];
                    }
                }
                
                // Если перевод не удался, используем fallback словарь
                return translateWithDictionary(text);
                
            } catch (error) {
                console.error('Ошибка перевода:', error);
                return translateWithDictionary(text);
            }
        }

        // Fallback словарь для перевода
        function translateWithDictionary(text) {
            const dictionary = {
                'яйцо': 'egg', 'яйца': 'eggs', 'яичный': 'egg',
                'яблоко': 'apple', 'яблоки': 'apples',
                'курица': 'chicken', 'куриный': 'chicken',
                'говядина': 'beef',
                'свинина': 'pork',
                'рыба': 'fish',
                'лосось': 'salmon',
                'творог': 'cottage cheese',
                'молоко': 'milk',
                'сыр': 'cheese',
                'хлеб': 'bread',
                'рис': 'rice',
                'гречка': 'buckwheat',
                'овсянка': 'oatmeal',
                'макароны': 'pasta',
                'картофель': 'potato',
                'морковь': 'carrot',
                'помидор': 'tomato',
                'огурец': 'cucumber',
                'банан': 'banana',
                'апельсин': 'orange',
                'виноград': 'grapes',
                'клубника': 'strawberry',
                'малина': 'raspberry',
                'орехи': 'nuts',
                'миндаль': 'almonds',
                'грецкий': 'walnut',
                'мед': 'honey',
                'сахар': 'sugar',
                'соль': 'salt',
                'перец': 'pepper',
                'масло': 'oil',
                'оливковое': 'olive oil',
                'подсолнечное': 'sunflower oil',
                'вода': 'water',
                'кофе': 'coffee',
                'чай': 'tea'
            };

            const words = text.toLowerCase().split(' ');
            let translatedWords = [];
            
            for (const word of words) {
                if (dictionary[word]) {
                    translatedWords.push(dictionary[word]);
                } else {
                    let found = false;
                    for (const [russian, english] of Object.entries(dictionary)) {
                        if (word.includes(russian)) {
                            translatedWords.push(english);
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        translatedWords.push(word);
                    }
                }
            }
            
            return translatedWords.join(' ');
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Функция для открытия модального окна
        function openModal(foodId, foodName) {
            currentFoodId = foodId;
            currentFoodName = foodName;
            selectedMeal = 'lunch';
            
            // Установка названия продукта в модальном окне
            document.getElementById('modal-food-name').textContent = foodName;
            
            // Сброс активного класса у всех опций
            document.querySelectorAll('.meal-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Установка активного класса для обеда (по умолчанию)
            document.querySelector('.meal-option[data-meal="lunch"]').classList.add('active');
            
            // Сброс значения граммов к 100
            document.getElementById('grams-input').value = 100;
            
            // Скрываем информацию о питательной ценности до получения данных
            document.getElementById('nutrition-info').style.display = 'none';
            
            // Получение деталей продукта для расчета питательных веществ
            getFoodDetails(foodId);
            
            document.getElementById('meal-modal').style.display = 'block';
        }

        // Функция для получения деталей продукта
        async function getFoodDetails(foodId) {
            try {
                const response = await fetch(`/get-food-details/${foodId}`);
                if (response.ok) {
                    const data = await response.json();
                    currentFoodDetails = data.food;
                    
                    // Извлекаем базовую пищевую ценность на 100г
                    if (currentFoodDetails && currentFoodDetails.servings) {
                        const servings = currentFoodDetails.servings.serving;
                        const serving = Array.isArray(servings) ? servings[0] : servings;
                        
                        // Получаем количество грамм в стандартной порции
                        const servingGrams = parseFloat(serving.metric_serving_amount || serving.grams || 100);
                        
                        // Рассчитываем пищевую ценность на 100г
                        baseNutrition = {
                            calories: Math.round(parseFloat(serving.calories) * (100 / servingGrams)),
                            protein: Math.round(parseFloat(serving.protein || 0) * (100 / servingGrams) * 10) / 10,
                            fat: Math.round(parseFloat(serving.fat || 0) * (100 / servingGrams) * 10) / 10,
                            carbs: Math.round(parseFloat(serving.carbohydrate || 0) * (100 / servingGrams) * 10) / 10
                        };
                        
                        // Обновляем информацию о питательной ценности
                        updateNutritionInfo();
                        
                        // Показываем блок с информацией
                        document.getElementById('nutrition-info').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Ошибка получения деталей продукта:', error);
            }
        }

        // Функция для обновления информации о питательной ценности
        function updateNutritionInfo() {
            if (!baseNutrition) return;
            
            const grams = parseInt(document.getElementById('grams-input').value) || 100;
            const ratio = grams / 100;
            
            // Обновляем количество грамм в заголовке
            document.getElementById('nutrition-grams').textContent = grams;
            
            // Рассчитываем и обновляем значения
            document.getElementById('nutrition-calories').textContent = Math.round(baseNutrition.calories * ratio);
            document.getElementById('nutrition-protein').textContent = (baseNutrition.protein * ratio).toFixed(1);
            document.getElementById('nutrition-fat').textContent = (baseNutrition.fat * ratio).toFixed(1);
            document.getElementById('nutrition-carbs').textContent = (baseNutrition.carbs * ratio).toFixed(1);
        }

        // Функция для расчета питательных веществ на основе веса
        function calculateNutrition(serving, grams) {
            if (!serving || !serving.calories) return null;
            
            const servingGrams = parseFloat(serving.metric_serving_amount || serving.grams || 100);
            const ratio = grams / servingGrams;
            
            return {
                calories: Math.round(parseFloat(serving.calories) * ratio),
                protein: Math.round(parseFloat(serving.protein || 0) * ratio * 10) / 10,
                fat: Math.round(parseFloat(serving.fat || 0) * ratio * 10) / 10,
                carbs: Math.round(parseFloat(serving.carbohydrate || 0) * ratio * 10) / 10,
                grams: grams
            };
        }

        function closeModal() {
            document.getElementById('meal-modal').style.display = 'none';
            currentFoodId = null;
            currentFoodName = null;
            baseNutrition = null;
        }

        // Функция для подтверждения выбора
        function confirmMealSelection() {
            const grams = parseInt(document.getElementById('grams-input').value) || 100;
            
            if (grams <= 0) {
                alert('Пожалуйста, введите корректное количество граммов');
                return;
            }
            
            if (currentFoodId && currentFoodName) {
                addToDiary(currentFoodId, currentFoodName, selectedMeal, grams, currentFoodDetails);
            }
            closeModal();
        }

        // Инициализация выбора приема пищи в модальном окне
        function initMealSelection() {
            document.querySelectorAll('.meal-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Удаляем активный класс у всех опций
                    document.querySelectorAll('.meal-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    
                    // Добавляем активный класс к выбранной опции
                    this.classList.add('active');
                    selectedMeal = this.getAttribute('data-meal');
                });
            });
        }

        // Функция для поиска продуктов
        async function searchFood() {
            const originalQuery = document.getElementById('food-query').value.trim();
            if (!originalQuery) {
                alert('Пожалуйста, введите название продукта');
                return;
            }

            const resultsDiv = document.getElementById('results-container');
            const translationInfo = document.getElementById('translation-info');
            const translationText = document.getElementById('translation-text');
            
            // Показываем загрузку перевода
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Переводим "${escapeHtml(originalQuery)}" на английский...</p>
                </div>
            `;

            try {
                // Переводим запрос на английский
                const englishQuery = await translateToEnglish(originalQuery);
                
                if (originalQuery !== englishQuery) {
                    translationText.innerHTML = `Поиск: "<strong>${escapeHtml(originalQuery)}</strong>" → "<strong>${escapeHtml(englishQuery)}</strong>"`;
                    translationInfo.style.display = 'block';
                } else {
                    translationInfo.style.display = 'none';
                }

                resultsDiv.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Ищем "${escapeHtml(originalQuery)}" в базе FatSecret...</p>
                        ${originalQuery !== englishQuery ? `<p>Переведено как: "${escapeHtml(englishQuery)}"</p>` : ''}
                    </div>
                `;

                const response = await fetch(`/search-food?query=${encodeURIComponent(englishQuery)}&region=RU&language=ru`);
                
                let data;
                if (response.ok) {
                    data = await response.json();
                    console.log('Ответ API:', data);
                } else {
                    throw new Error('Ошибка API, используем демо-данные');
                }
                
                if (data.foods && data.foods.food && data.foods.food.length > 0) {
                    displayResults(data.foods.food, originalQuery, englishQuery);
                } else if (data.food) {
                    displayResults([data.food], originalQuery, englishQuery);
                } else {
                    throw new Error('Не найдено продуктов');
                }
                
            } catch (error) {
                console.error('Ошибка поиска:', error);
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <h3><i class="fas fa-exclamation-triangle"></i> Ошибка поиска</h3>
                        <p>${escapeHtml(error.message) || 'Не удалось выполнить поиск'}</p>
                        <button class="retry-btn" onclick="searchFood()">
                            <i class="fas fa-redo"></i> Попробовать снова
                        </button>
                    </div>
                `;
            }
        }
        
        // Функция для отображения результатов (без питательных веществ)
        function displayResults(foods, originalQuery, englishQuery) {
            const container = document.getElementById('results-container');
            
            if (!foods || foods.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <p>Ничего не найдено для "${escapeHtml(originalQuery)}"</p>
                        ${originalQuery !== englishQuery ? `<p>Поисковый запрос: "${escapeHtml(englishQuery)}"</p>` : ''}
                        <p>Попробуйте другой запрос</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="api-info">
                    <i class="fas fa-info-circle"></i> 
                    Найдено продуктов: ${foods.length} | 
                    Поиск: "${escapeHtml(originalQuery)}" 
                    ${originalQuery !== englishQuery ? `→ "${escapeHtml(englishQuery)}"` : ''}
                </div>
                <div class="food-grid">
            `;
            
            foods.forEach(food => {
                const foodName = escapeHtml(food.food_name || 'Неизвестный продукт');
                const foodId = escapeHtml(food.food_id || '');
                const foodType = escapeHtml(food.food_type || 'продукт');
                
                html += `
                <div class="food-card">
                    <div class="food-name">${foodName}</div>
                    
                    <div class="food-image">
                        ${food.food_image ? 
                          `<img src="${escapeHtml(food.food_image)}" alt="${foodName}" style="width:100%;height:100%;border-radius:10px;">` : 
                          '🍎'}
                    </div>
                    
                    <div class="serving-info">
                        ${food.food_type ? `Тип: ${escapeHtml(foodType)}` : 'Основной продукт'}
                    </div>
                    
                    <button class="add-btn" onclick="openModal('${foodId}', '${foodName.replace(/'/g, "\\'")}')">
                        <i class="fas fa-plus"></i> Добавить в рацион
                    </button>
                </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getMealName(mealType) {
            const meals = {
                'breakfast': 'завтрак',
                'lunch': 'обед',
                'dinner': 'ужин',
                'snack': 'перекус'
            };
            return meals[mealType] || 'дневник';
        }

        // Функция для добавления продукта в дневник
        async function addToDiary(foodId, foodName, mealType, grams, foodDetails = null) {
            const buttons = document.querySelectorAll('.add-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(foodName)) {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Добавляем...`;
                }
            });
            
            try {
                // Если у нас есть детали продукта, рассчитаем питательные вещества
                let nutritionData = null;
                if (foodDetails && foodDetails.servings) {
                    const servings = foodDetails.servings.serving;
                    const serving = Array.isArray(servings) ? servings[0] : servings;
                    nutritionData = calculateNutrition(serving, grams);
                }
                
                const response = await fetch('/add-from-fatsecret', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        food_id: foodId,
                        meal_type: mealType,
                        grams: grams,
                        nutrition_data: nutritionData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`✅ "${foodName}" (${grams}г) добавлен в ${getMealName(mealType)}!`);
                    } else {
                        throw new Error(result.error || 'Ошибка при добавлении');
                    }
                } else {
                    throw new Error('Ошибка сервера');
                }
            } catch (error) {
                alert('❌ Ошибка: ' + error.message);
            } finally {
                buttons.forEach(btn => {
                    if (btn.textContent.includes('Добавляем')) {
                        btn.disabled = false;
                        btn.innerHTML = `<i class="fas fa-plus"></i> Добавить в рацион`;
                    }
                });
            }
        }

        // Поиск по нажатию Enter
        document.getElementById('food-query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchFood();
        });
        
        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('meal-modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            initMealSelection();
            document.getElementById('food-query').focus();
        });
    </script>
</body>
</html>